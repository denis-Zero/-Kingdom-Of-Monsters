<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventura de Criaturas</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-color: #16213e;
            --accent-color: #e94560;
            --text-color: #ffffff;
            --success-color: #4ecca3;
            --danger-color: #ff4d4d;
            --xp-color: #00ff0d;
            --base-font-size: 16px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: var(--base-font-size);
        }

        #main-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            gap: 20px;
        }

        #main-menu h1 {
            font-size: 4rem;
            color: var(--accent-color);
            text-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
            margin-bottom: 40px;
        }

        .menu-btn {
            width: 250px;
            font-size: 1.2rem;
            padding: 15px;
            letter-spacing: 2px;
        }

        #game-container {
            width: calc(100% - 160px); /* Espa√ßo para a sidebar */
            max-width: 800px;
            padding: 20px;
            box-sizing: border-box;
            display: none;
            margin-left: 150px; /* Margem para n√£o bater na sidebar √† esquerda */
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Exploration Grid */
        #exploration-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .card {
            aspect-ratio: 2/3;
            background-color: var(--card-color);
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            transform-style: preserve-3d;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);
        }

        .card.revealed {
            cursor: default;
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .card-back {
            background: linear-gradient(45deg, #16213e, #0f3460);
        }

        .card-front {
            background: #ffffff;
            color: #000;
            transform: rotateY(180deg);
            flex-direction: column;
            font-size: 1.2rem;
            text-align: center;
            padding: 10px;
        }

        /* Battle UI */
        #battle-screen {
            display: none;
            flex-direction: column;
            gap: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--accent-color);
        }

        .battle-arena {
            display: flex;
            justify-content: space-around;
            align-items: center;
            min-height: 200px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .fighter {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .enemy-fighter {
            flex: 0 1 150px;
        }

        .fighter-emoji {
            font-size: 5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            height: 150px;
        }

        .fighter-emoji img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .creature-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            display: block;
            margin: 0 auto 5px;
        }

        .team-img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .hp-bar-container, .xp-bar-container {
            width: 100%;
            height: 18px; /* Aumentado de 12px */
            background: #222; /* Fundo mais escuro para contraste */
            border-radius: 9px;
            overflow: hidden;
            margin: 8px 0;
            border: 2px solid #444; /* Borda para destaque */
            position: relative;
        }

        .enemy-hp-container {
            height: 14px;
            margin: 4px 0;
        }

        .hp-bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #2ecc71, #27ae60); /* Gradiente para ficar mais bonito */
            width: 100%; 
            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }
        
        .xp-bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #f1c40f, #f39c12); 
            width: 0%; 
            transition: width 0.4s ease; 
        }

        .hp-text {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
            z-index: 10;
            pointer-events: none;
        }

        .battle-logs {
            height: 120px;
            background: #000;
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            border: 1px solid #333;
        }

        .battle-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: filter 0.2s;
        }

        button:hover { filter: brightness(1.2); }
        button:disabled { background-color: #555; cursor: not-allowed; }

        /* Tooltip style removido para usar apenas Double Click */
        .tooltip .tooltiptext {
            display: none;
        }

        /* Overlay & Selection */
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 300;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        .selection-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }

        .creature-card {
            background: var(--card-color);
            border: 2px solid var(--accent-color);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            width: 130px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .creature-card:hover { transform: scale(1.05); background: #1f2b4e; }
        .creature-card.selected { border-color: white; box-shadow: 0 0 10px white; }
        .creature-card.dead { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        /* Team Sidebar (Anteriormente Footer) */
        #team-footer {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 120px; /* Largura fixa para sidebar */
            background: rgba(22, 33, 62, 0.95);
            padding: 15px;
            display: flex;
            flex-direction: column; /* Vertical */
            align-items: center;
            gap: 15px;
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            z-index: 150;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .team-member {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 3rem; /* Ainda maior */
            cursor: help;
            width: 100%;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
        }

        .team-member:last-child {
            border-bottom: none;
        }

        .team-member .mini-bars {
            width: 80px; /* Aumentado */
            margin-top: 6px;
        }

        .team-img {
            width: 100px; /* Aumentado de 80px */
            height: 100px; /* Aumentado de 80px */
            object-fit: contain;
        }

        .mini-bar {
            height: 4px;
            background: #444;
            margin-bottom: 2px;
            border-radius: 2px;
            overflow: hidden;
        }

        .mini-bar-fill-hp { height: 100%; background: var(--success-color); }
        .mini-bar-fill-xp { height: 100%; background: var(--xp-color); }

        .hidden { display: none !important; }

        .modal {
            background: var(--card-color);
            padding: 20px;
            border-radius: 15px;
            max-width: 600px;
            width: 95%;
            text-align: center;
            border: 2px solid var(--accent-color);
            position: relative;
        }

        .shop-diamonds {
            position: absolute;
            top: 10px;
            right: 20px;
            font-weight: bold;
            color: #00d2ff;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 20px;
        }
    </style>
</head>
<body>

<div id="main-menu" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: var(--bg-color); position: fixed; top: 0; left: 0; width: 100%; z-index: 200;">
    <h1 style="font-size: 4rem; color: var(--accent-color); margin-bottom: 30px; text-shadow: 0 0 20px var(--accent-color);">Aventura</h1>
    <button class="menu-btn" onclick="startNewGame()" style="width: 250px; margin: 10px; font-size: 1.2rem;">NOVO JOGO</button>
    <button class="menu-btn" id="continue-btn" disabled onclick="continueGame()" style="width: 250px; margin: 10px; font-size: 1.2rem;">CONTINUAR</button>
    <button class="menu-btn" onclick="showOptionsMenu()" style="width: 250px; margin: 10px; font-size: 1.2rem;">OP√á√ïES</button>
    <button class="menu-btn" onclick="window.close()" style="width: 250px; margin: 10px; font-size: 1.2rem;">SAIR</button>
</div>

<div id="game-container">
    <header>
        <h1>Aventura de Cartas</h1>
    </header>

    <div class="stats-bar">
        <span>N√≠vel: <span id="current-level">1</span>/50</span>
        <span>Time: <span id="creature-count">0</span>/6</span>
        <span>Diamantes: <span id="player-diamantes">10</span> üíé</span>
        <button onclick="showOptionsMenu()" style="padding: 2px 10px; font-size: 0.8rem; background: var(--card-color); border: 1px solid var(--accent-color);">‚öôÔ∏è Op√ß√µes</button>
    </div>

    <div id="exploration-grid"></div>

    <div id="battle-screen">
        <div class="battle-arena">
            <div class="fighter" id="player-fighter">
                <div class="fighter-emoji">üõ°Ô∏è</div>
                <div class="hp-bar-container">
                    <div id="player-hp-bar" class="hp-bar-fill"></div>
                    <div id="player-hp-text" class="hp-text">100/100</div>
                </div>
                <div class="xp-bar-container">
                    <div id="player-xp-bar" class="xp-bar-fill"></div>
                    <div id="player-xp-text" class="hp-text" style="font-size: 0.6rem;">Lvl 1 - 0/100 XP</div>
                </div>
                <strong id="player-name">Jogador</strong>
            </div>
            <div style="font-size: 2rem;">VS</div>
            <div id="enemies-container" style="display: flex; gap: 10px; flex: 2; justify-content: center; flex-wrap: wrap;">
                <!-- Inimigos ser√£o inseridos aqui -->
            </div>
        </div>
        <div class="battle-logs" id="battle-logs"></div>
        <div class="battle-actions" id="battle-actions"></div>
    </div>
</div>

<div id="overlay">
    <div class="modal" id="modal-content">
        <div id="modal-diamonds-hud" class="shop-diamonds hidden">üíé <span id="modal-diamonds-val">0</span></div>
        <h2 id="modal-title">T√≠tulo</h2>
        <div id="modal-body">Conte√∫do aqui</div>
        <div id="modal-footer" class="selection-grid"></div>
        <div id="modal-actions" style="margin-top: 20px;"></div>
    </div>
</div>

<div id="team-footer"></div>

<script>
    // --- Data Definitions ---
    const CREATURE_POOL = [
        { id: 'dragao', name: "Drag√£o", emoji: "ü¶ñ", image: "dragao.png", hp: 120, attacks: [{name: "Sopro de Fogo", min: 25, max: 35}, {name: "Mordida", min: 20, max: 25}], evo: { level: 7, name: "Rei Drag√£o", emoji: "üêâ", image: "rei_dragao.png", hpBoost: 105, dmgBoost: 102 } }, 
        { id: 'fenix', name: "F√™nix", emoji: "üê¶‚Äçüî•", image: "fenix.png", hp: 100, attacks: [{name: "Brasas", min: 12, max: 20}, {name: "Picada Solar", min: 10, max: 30,}], evo: { level: 8, name: "F√™nix Ancestral", emoji: "ü¶Ö", image: "fenix_ancestral.png", hpBoost: 120, dmgBoost: 90 } },
        { id: 'golem', name: "Golem", emoji: "üóø", image: "golem.png", hp: 150, attacks: [{name: "Soco de Pedra", min: 10, max: 20}, {name: "Esmagar", min: 18, max: 22}], evo: { level: 10, name: "Golem de Ferro", emoji: "ü§ñ", image: "golem_ferro.png", hpBoost: 100, dmgBoost: 100 } },
        { id: 'unicornio', name: "Unic√≥rnio", emoji: "ü¶Ñ", image: "unicornio.png", hp: 90, attacks: [{name: "Raio M√≠stico", min: 20, max: 25}, {name: "Investida", min: 10, max: 15}], evo: { level: 5, name: "Alic√≥rnio", emoji: "ü´é", image: "alicornio.png", hpBoost: 59, dmgBoost: 62 } },
        { id: 'lobo', name: "Lobo", emoji: "üê∫", image: "lobo.png", hp: 80, attacks: [{name: "Uivo Mortal", min: 5, max: 35}, {name: "Arranh√£o", min: 12, max: 18}], evo: { level: 5, name: "Lobisomem", emoji: "üê∫", image: "lobisomem.png", hpBoost: 90, dmgBoost: 75 } },
        { id: 'tartaruga', name: "Tartaruga", emoji: "üê¢", image: "tartaruga.png", hp: 200, attacks: [{name: "Casco Pesado", min: 5, max: 15}, {name: "Jato d'√°gua", min: 10, max: 20}], evo: { level: 5, name: "Tartaruga Gigante", emoji: "üê¢", image: "tartaruga_gigante.png", hpBoost: 100, dmgBoost: 55 } },
        { id: 'goblin', name: "Goblin", emoji: "üßå", image: "goblin.png", hp: 105, attacks: [{name: "Dilacerar", min: 18, max: 20}, {name: "Carnificina", min: 15, max: 30}], evo: { level: 10, name: "Goblin Supremo", emoji: "üßå", image: "goblin_supremo.png", hpBoost: 120, dmgBoost: 80 }},
        { id: 'morcego', name: "Morcego", emoji: "ü¶á", image: "morcego.png", hp: 70, attacks: [{name: "Sugada", min: 8, max: 12}, {name: "Eco-ataque", min: 12, max: 22}], evo: { level: 9, name: "Vampiro", emoji: "üßõ", image: "vampiro.png", hpBoost: 50, dmgBoost: 80 } },
        { id: 'zumbi', name: "zumbi", emoji: "üßü", image: "zumbi.png", hp: 85, attacks: [{name: "Mordida", min: 10, max: 20}, {name: "Desmembramento", min: 14, max: 18}], evo: { level: 7, name: "Zumbi Forte", emoji: "üßü‚Äç‚ôÇÔ∏è", image: "zumbi_forte.png", hpBoost: 45, dmgBoost: 38 } },
        { id: 'polvo', name: "Polvo", emoji: "üêô", image: "polvo.png", hp: 110, attacks: [{name: "Onda de Choque", min: 12, max: 22}, {name: "Tsunami", min: 18, max: 28}], evo: { level: 8, name: "Leviat√£", emoji: "ü¶ë", image: "leviata.png", hpBoost: 60, dmgBoost: 12 } },
        { id: 'fada', name: "Fada", emoji: "üßö‚Äç‚ôÄÔ∏è", image: "fada.png", hp: 75, attacks: [{name: "P√≥ de Estrela", min: 15, max: 25}, {name: "Cura Ofensiva", min: 10, max: 20}], evo: { level: 6, name: "Rainha Fada", emoji: "üë∏", image: "rainha_fada.png", hpBoost: 50, dmgBoost: 40 } },
        { id: 'esquilo', name: "Esquilo", emoji: "üêøÔ∏è", image: "esquilo.png", hp: 65, attacks: [{name: "Noz Explosiva", min: 12, max: 15}, {name: "Mordida R√°pida", min: 8, max: 12}], evo: { level: 5, name: "Esquilo Guerreiro", emoji: "üõ°Ô∏è", image: "esquilo_guerreiro.png", hpBoost: 150, dmgBoost: 75 } },
        { id: 'mago', name: "Mago", emoji: "üßô‚Äç‚ôÄÔ∏è", image: "mago.png", hp: 95, attacks: [{name: "Faisca Poderosa", min: 45, max: 45}, {name: "Chuva de Pedras", min: 0, max: 100}], evo: { level: 5, name: "Rei Mago", emoji: "üßô‚Äç‚ôÇÔ∏è", image: "rei_mago.png", hpBoost: 100, dmgBoost: 70 } }
    ];

    const BOSS = { name: "REI DEM√îNIO", emoji: "üë∫", image: "boss.png", hp: 800, attacks: [{name: "Apocalipse", min: 0, max: 500}, {name: "Garras do Caos", min: 30, max: 50}, {name: "Chama Negra", min: 35, max: 45}] }; 

    const ITEMS = {
        // Ofensiva
        'garra_obsidiana': { id: 'garra_obsidiana', name: "Garra de Obsidiana", desc: "+8 de dano fixo em todos os ataques.", cost: 150, type: 'offense', icon: "üíé", image: "garra_obsidiana.png" },
        'anel_fogo': { id: 'anel_fogo', name: "Anel de Fogo", desc: "Aumenta o dano m√°ximo em 15.", cost: 120, type: 'offense', icon: "üî•", image: "anel_fogo.png" },
        'amolador_presas': { id: 'amolador_presas', name: "Amolador de Presas", desc: "Dano m√≠nimo nunca √© inferior a 20.", cost: 100, type: 'offense', icon: "ü¶¥", image: "amolador_presas.png" },
        'cajado_runico': { id: 'cajado_runico', name: "Cajado R√∫nico", desc: "+50% de dano para evolu√ß√µes finais.", cost: 200, type: 'offense', icon: "ü™Ñ", image: "cajado_runico.png" },
        // Defensiva
        'casco_adamante': { id: 'casco_adamante', name: "Casco de Adamante", desc: "+100 de HP m√°ximo.", cost: 130, type: 'defense', icon: "üõ°Ô∏è", image: "casco_adamante.png" },
        'manto_esquiva': { id: 'manto_esquiva', name: "Manto da Esquiva", desc: "25% de chance de desviar de ataques.", cost: 180, type: 'defense', icon: "üß£", image: "manto_esquiva.png" },
        'colar_regeneracao': { id: 'colar_regeneracao', name: "Colar de Regenera√ß√£o", desc: "Cura uma parte do HP total ao atacar.", cost: 150, type: 'defense', icon: "üìø", image: "colar_regeneracao.png" },
        'escudo_espinhos': { id: 'escudo_espinhos', name: "Escudo de Espinhos", desc: "Reflete 45% do dano recebido.", cost: 140, type: 'defense', icon: "üåµ", image: "escudo_espinhos.png" },
        // Utilit√°rios
        'grimorio_aprendiz': { id: 'grimorio_aprendiz', name: "Grim√≥rio de Aprendiz", desc: "+60% de ganho de XP.", cost: 100, type: 'utility', icon: "üìñ", image: "grimorio_aprendiz.png" },
        'bolsa_moedas': { id: 'bolsa_moedas', name: "Bolsa de Moedas", desc: "+100 diamantes em ba√∫s de tesouro.", cost: 80, type: 'utility', icon: "üí∞", image: "bolsa_moedas.png" },
        'incenso_atrativo': { id: 'incenso_atrativo', name: "Incenso Atrativo", desc: "Aumenta chance de captura em encontros.", cost: 90, type: 'utility', icon: "üí®", image: "incenso_atrativo.png" },
        'pedra_evolucao': { id: 'pedra_evolucao', name: "Pedra da Evolu√ß√£o Precoce", desc: "Evolui 1 n√≠vel antes do requisito.", cost: 150, type: 'utility', icon: "üí†", image: "pedra_evolucao.png" },
        // Raros (N√≠vel 30+)
        'coroa_demonio': { id: 'coroa_demonio', name: "Coroa do Rei Dem√¥nio", desc: "+20 de dano, mas corta HP pela metade.", cost: 400, type: 'rare', icon: "üëë", image: "coroa_demonio.png", minLevel: 30 },
        'fenix_bolso': { id: 'fenix_bolso', name: "F√™nix de Bolso", desc: "Revive uma vez com 30% HP (Quebra ap√≥s o uso).", cost: 500, type: 'rare', icon: "üê£", image: "fenix_bolso.png", minLevel: 30 },
        'espelho_mistico': { id: 'espelho_mistico', name: "Espelho M√≠stico", desc: "Reflete o ataque mais forte do inimigo.", cost: 450, type: 'rare', icon: "ü™û", image: "espelho_mistico.png", minLevel: 30 }
    };

    // --- Sound System ---
    const SOUNDS = {
        'click': 'sons/click.mp3',
        'battle_start': 'sons/battle_start.mp3',
        'attack': 'sons/attack.mp3',
        'hit': 'sons/hit.mp3',
        'victory': 'sons/victory.mp3',
        'defeat': 'sons/defeat.mp3',
        'card_flip': 'sons/card_flip.mp3',
        'treasure': 'sons/treasure.mp3',
        'shop': 'sons/shop.mp3',
        'evolution': 'sons/evolution.mp3',
        'boss_battle': 'sons/boss_battle.mp3'
    };

    let currentAudio = null;

    function playSound(name) {
        if (state.options.muted) return;
        const audio = new Audio(SOUNDS[name]);
        let vol = state.options.volume || 0.5;
        if (name === 'hit') vol = Math.min(1.0, vol * 3); // Aumenta o volume do hit
        audio.volume = vol;
        
        if (name === 'defeat') currentAudio = audio; // Armazena √°udio de derrota para parar depois
        
        audio.play().catch(e => console.log("Erro ao tocar som: " + e));
    }

    function stopSound() {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            currentAudio.src = ""; // Limpa a fonte para garantir que parou
            currentAudio = null;
        }
    }

    // --- Game State ---
    let state = {
        level: 1,
        team: [],
        maxTeamSize: 6,
        cardsRevealed: 0,
        enemies: [], // Agora suporta m√∫ltiplos inimigos
        activePlayerCreature: null,
        isBossBattle: false,
        swapsUsed: 0,
        selectedIniciais: [],
        diamantes: 10,
        lockedShopItem: null,
        currentShopItems: null,
        options: {
            fontSize: 16,
            isFullScreen: false,
            muted: false,
            volume: 0.5
        }
    };

    // --- Core Functions ---

    function startNewGame() {
        playSound('click');
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        initGame();
    }

    function continueGame() {
        const saved = localStorage.getItem('aventura_save');
        if (saved) {
            state = JSON.parse(saved);
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            updateUI();
            generateLevel();
        }
    }

    function saveGame() {
        localStorage.setItem('aventura_save', JSON.stringify(state));
        document.getElementById('continue-btn').disabled = false;
    }

    function showOptionsMenu() {
        showModal("Op√ß√µes", "", [
            { text: "Aumentar Texto", action: () => changeFontSize(2) },
            { text: "Diminuir Texto", action: () => changeFontSize(-2) },
            { text: "Alternar FullScreen", action: toggleFullScreen },
            { text: state.options.muted ? "Ativar Som" : "Mudar Som", action: toggleMute },
            { text: "Exportar Save", action: exportSave },
            { text: "Importar Save", action: importSave },
            { text: "Voltar ao Menu", action: () => location.reload() },
            { text: "Fechar", action: hideModal }
        ]);
    }

    function toggleMute() {
        state.options.muted = !state.options.muted;
        saveGame();
        showOptionsMenu();
    }

    function exportSave() {
        const dataStr = JSON.stringify(state);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        
        const exportFileDefaultName = 'save_aventura.json';
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        addLog("Save exportado com sucesso!");
    }

    function importSave() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = readerEvent => {
                try {
                    const content = readerEvent.target.result;
                    state = JSON.parse(content);
                    saveGame();
                    alert("Save importado com sucesso! O jogo ir√° recarregar.");
                    location.reload();
                } catch (err) {
                    alert("Erro ao importar o arquivo!");
                }
            }
            reader.readAsText(file);
        }
        input.click();
    }

    function changeFontSize(delta) {
        state.options.fontSize = Math.min(24, Math.max(12, state.options.fontSize + delta));
        document.documentElement.style.setProperty('--base-font-size', state.options.fontSize + 'px');
        saveGame();
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(e => {
                alert(`Erro ao tentar entrar em modo tela cheia: ${e.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    function startInitialSelection() {
        state.team = [];
        state.selectedIniciais = [];
        showModal("Escolha seus 3 Iniciais", "Selecione as criaturas que come√ßar√£o sua jornada:", []);
        
        const footer = document.getElementById('modal-footer');
        footer.innerHTML = '';
        
        CREATURE_POOL.forEach(c => {
            const card = document.createElement('div');
            card.className = 'creature-card tooltip';
            card.innerHTML = `
                ${getCreatureDisplay(c, 'creature-img')}<br><strong>${c.name}</strong><br>HP: ${c.hp}
                <span class="tooltiptext">${getCreatureTooltip({...c, level: 1, currentHp: c.hp})}</span>
            `;
            card.onclick = () => {
                if (card.classList.contains('selected')) {
                    card.classList.remove('selected');
                    state.selectedIniciais = state.selectedIniciais.filter(i => i.id !== c.id);
                } else if (state.selectedIniciais.length < 3) {
                    card.classList.add('selected');
                    state.selectedIniciais.push({...c});
                }
                updateSelectionButton();
            };
            footer.appendChild(card);
        });

        const actions = document.getElementById('modal-actions');
        actions.innerHTML = '<button id="confirm-iniciais" disabled>Confirmar (0/3)</button>';
        document.getElementById('confirm-iniciais').onclick = () => {
            state.team = state.selectedIniciais.map(c => initCreature(c));
            hideModal();
            initGame(true);
        };
    }

    function updateSelectionButton() {
        const btn = document.getElementById('confirm-iniciais');
        btn.innerText = `Confirmar (${state.selectedIniciais.length}/3)`;
        btn.disabled = state.selectedIniciais.length !== 3;
    }

    function initCreature(base) {
        return {
            ...JSON.parse(JSON.stringify(base)),
            level: 1,
            xp: 0,
            maxXp: 100,
            currentHp: base.hp,
            isEvolved: false,
            items: [] // Mudado de item: null para items: [] para suportar at√© 3
        };
    }

    function initGame(alreadySelected = false) {
        if (!alreadySelected) {
            startInitialSelection();
            return;
        }
        state.level = 1;
        state.cardsRevealed = 0;
        state.isBossBattle = false;
        state.diamantes = 50; // Come√ßa com um pouco de diamantes
        state.currentShopItems = null;
        updateUI();
        generateLevel();
        saveGame();
    }

    function updateUI() {
        document.getElementById('current-level').innerText = state.level;
        document.getElementById('creature-count').innerText = state.team.length;
        document.getElementById('player-diamantes').innerText = state.diamantes;
        
        // Atualiza diamante no modal se estiver vis√≠vel
        const diamondVal = document.getElementById('modal-diamonds-val');
        if (diamondVal) diamondVal.innerText = state.diamantes;

        const footer = document.getElementById('team-footer');
        footer.innerHTML = '';
        state.team.forEach(c => {
            const div = document.createElement('div');
            div.className = 'team-member tooltip';
            const hpPercent = (c.currentHp / c.hp) * 100;
            const xpPercent = (c.xp / c.maxXp) * 100;
            
            div.innerHTML = `
                ${getCreatureDisplay(c, 'team-img')}
                <div class="mini-bars">
                    <div class="mini-bar"><div class="mini-bar-fill-hp" style="width: ${hpPercent}%"></div></div>
                    <div class="mini-bar"><div class="mini-bar-fill-xp" style="width: ${xpPercent}%"></div></div>
                </div>
                <span class="tooltiptext">${getCreatureTooltip(c)}</span>
            `;
            div.ondblclick = () => {
                showModal("Status da Criatura", getCreatureTooltip(c), [{ text: "Fechar", action: hideModal }]);
            };
            footer.appendChild(div);
        });

        if (state.team.length > 0 && state.team.filter(c => c.currentHp > 0).length === 0) {
            gameOver();
        }
        saveGame();
    }

    function generateLevel() {
        state.cardsRevealed = 0;
        saveGame();
        const grid = document.getElementById('exploration-grid');
        grid.innerHTML = '';
        grid.classList.remove('hidden');
        document.getElementById('battle-screen').style.display = 'none';

        if (state.level % 10 === 0) {
            startBossBattle();
            return;
        }

        for (let i = 0; i < 6; i++) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="card-face card-back">‚ùì</div><div class="card-face card-front"></div>`;
            
            const rand = Math.random();
            let type = rand < 0.4 ? 'COMBAT' : (rand < 0.7 ? 'ENCOUNTER' : 'TREASURE');
            
            card.dataset.type = type;
            card.onclick = () => openCard(card);
            grid.appendChild(card);
        }
    }

    function openCard(cardElement) {
        if (cardElement.classList.contains('revealed')) return;
        playSound('card_flip');
        cardElement.classList.add('revealed');
        state.cardsRevealed++;
        
        updateUI();

        const type = cardElement.dataset.type;
        const front = cardElement.querySelector('.card-front');
        
        setTimeout(() => {
            if (type === 'COMBAT') {
                front.innerHTML = "‚öîÔ∏è<br>COMBATE!"; front.style.color = "red";
                const enemyCount = state.level > 10 ? Math.min(3, 1 + Math.floor(Math.random() * 3)) : 1;
                const enemies = [];
                for (let i = 0; i < enemyCount; i++) enemies.push(getRandomEnemy());
                setTimeout(() => startBattle(enemies), 600);
            } else if (type === 'ENCOUNTER') {
                front.innerHTML = "üë£<br>ENCONTRO"; front.style.color = "blue";
                setTimeout(() => startEncounter(getRandomEnemy()), 600);
            } else {
                front.innerHTML = "üçÄüíÄ<br>TESOURO"; front.style.color = "green";
                setTimeout(() => handleTreasure(), 600);
            }
        }, 300);
    }

    function getRandomEnemy() {
        const base = CREATURE_POOL[Math.floor(Math.random() * CREATURE_POOL.length)];
        let enemy = initCreature(base);
        
        // Escala n√≠vel do inimigo com base no n√≠vel do jogador
        const levelBoost = Math.floor(state.level / 2);
        enemy.level += levelBoost;
        enemy.hp += levelBoost * 20;
        enemy.attacks.forEach(a => { a.min += levelBoost * 2; a.max += levelBoost * 3; });

        // A partir do n√≠vel 10, inimigos podem vir evolu√≠dos ou com itens
        if (state.level > 10) {
            // Chance de vir evolu√≠do (se tiver evolu√ß√£o)
            if (enemy.evo && Math.random() < 0.4) {
                const oldName = enemy.name;
                enemy.name = enemy.evo.name;
                enemy.emoji = enemy.evo.emoji;
                if (enemy.evo.image) enemy.image = enemy.evo.image;
                enemy.hp += enemy.evo.hpBoost;
                enemy.attacks.forEach(a => { a.min += enemy.evo.dmgBoost; a.max += enemy.evo.dmgBoost; });
                enemy.isEvolved = true;
            }

            // Chance de vir com equipamento (1 a 2 itens)
            if (Math.random() < 0.5) {
                const availableItems = Object.values(ITEMS).filter(i => !i.minLevel || state.level >= i.minLevel);
                const itemCount = Math.random() < 0.8 ? 1 : 2;
                for (let i = 0; i < itemCount; i++) {
                    const randomItem = JSON.parse(JSON.stringify(availableItems[Math.floor(Math.random() * availableItems.length)]));
                    randomItem.level = Math.max(1, Math.floor(state.level / 15)); // Itens podem vir com n√≠vel maior
                    enemy.items.push(randomItem);
                    
                    // Aplica efeitos imediatos se necess√°rio (ex: Casco de Adamante)
                    if (randomItem.id === 'casco_adamante') enemy.hp += 100;
                }
            }
        }

        enemy.currentHp = enemy.hp;
        return enemy;
    }

    // --- Battle & XP Logic ---

    function startBattle(enemyOrEnemies, isBoss = false) {
        state.enemies = Array.isArray(enemyOrEnemies) ? enemyOrEnemies : [enemyOrEnemies];
        state.isBossBattle = isBoss;
        state.swapsUsed = 0; // Reseta trocas no in√≠cio da batalha
        playSound(isBoss ? 'boss_battle' : 'battle_start');
        showCreatureSelection((selected) => {
            state.activePlayerCreature = selected;
            document.getElementById('exploration-grid').classList.add('hidden');
            document.getElementById('battle-screen').style.display = 'flex';
            setupBattleUI();
            addLog(`Batalha: ${selected.name} vs ${state.enemies.map(e => e.name).join(', ')}!`);
            
            // Aleat√≥rio quem come√ßa atacando
            if (Math.random() < 0.5) {
                addLog("O inimigo foi mais r√°pido e ataca primeiro!");
                toggleButtons(true);
                setTimeout(enemyTurn, 1000);
            } else {
                addLog("Voc√™ foi mais r√°pido e come√ßa atacando!");
            }
        }, "Escolha quem vai lutar:", true); // true para filtrar quem est√° descansando
    }

    function setupBattleUI() {
        const p = state.activePlayerCreature;

        const playerFighter = document.getElementById('player-fighter');
        playerFighter.querySelector('.fighter-emoji').innerHTML = getCreatureDisplay(p);
        playerFighter.ondblclick = () => {
                showModal("Status: " + p.name, getCreatureTooltip(p), [{ text: "Fechar", action: hideModal }]);
            };

        document.getElementById('player-name').innerText = p.name;
        updateHpUI('player', p);
        updateXpUI(p);

        const enemiesContainer = document.getElementById('enemies-container');
        enemiesContainer.innerHTML = '';

        state.enemies.forEach((e, index) => {
            const enemyDiv = document.createElement('div');
            enemyDiv.className = 'fighter enemy-fighter';
            enemyDiv.id = `enemy-fighter-${index}`;
            if (e.currentHp <= 0) enemyDiv.style.opacity = '0.3';
            
            enemyDiv.innerHTML = `
                <div class="fighter-emoji" style="font-size: 4rem; height: 110px;">${getCreatureDisplay(e)}</div>
                <div class="hp-bar-container enemy-hp-container">
                    <div id="enemy-${index}-hp-bar" class="hp-bar-fill"></div>
                    <div id="enemy-${index}-hp-text" class="hp-text" style="font-size: 0.6rem;">${Math.floor(e.currentHp)}/${e.hp}</div>
                </div>
                <strong style="font-size: 0.8rem;">${e.name}</strong>
            `;
            
            enemyDiv.ondblclick = () => {
                showModal("Status: " + e.name, getCreatureTooltip(e), [{ text: "Fechar", action: hideModal }]);
            };
            
            if (e.currentHp > 0) {
                enemyDiv.style.cursor = 'crosshair';
                enemyDiv.title = "Clique para atacar este inimigo";
            }
            
            enemiesContainer.appendChild(enemyDiv);
            updateHpUI(`enemy-${index}`, e);
        });

        const actions = document.getElementById('battle-actions');
        actions.innerHTML = '';
        p.attacks.forEach(atk => {
            const btn = document.createElement('button');
            btn.innerText = `${atk.name} (${atk.min}-${atk.max})`;
            btn.onclick = () => {
                if (state.enemies.length === 1) {
                    playerAttack(atk, 0);
                } else {
                    addLog(`Escolha o alvo para ${atk.name}!`);
                    const aliveEnemies = state.enemies.map((e, i) => e.currentHp > 0 ? i : -1).filter(i => i !== -1);
                    aliveEnemies.forEach(i => {
                        const enemyEl = document.getElementById(`enemy-fighter-${i}`);
                        enemyEl.style.boxShadow = "0 0 15px red";
                        enemyEl.onclick = () => {
                            // Limpa destaques
                            aliveEnemies.forEach(idx => {
                                const el = document.getElementById(`enemy-fighter-${idx}`);
                                el.style.boxShadow = "";
                                el.onclick = null;
                            });
                            playerAttack(atk, i);
                        };
                    });
                }
            };
            actions.appendChild(btn);
        });
        
        // Bot√£o de Troca
        if (state.swapsUsed < 2) {
            const swapBtn = document.createElement('button');
            swapBtn.innerText = `Trocar (${2 - state.swapsUsed})`;
            swapBtn.style.backgroundColor = "#555";
            swapBtn.onclick = () => {
                showCreatureSelection((newCreature) => {
                    if (newCreature.id === p.id) {
                        addLog("Esta criatura j√° est√° em combate!");
                        setupBattleUI();
                        return;
                    }
                    
                    p.restCount = 2; // Marca a antiga como descansando (n√£o pode ser usada na pr√≥xima batalha)
                    state.swapsUsed++;
                    state.activePlayerCreature = newCreature;
                    addLog(`${p.name} saiu para descansar. ${newCreature.name} entrou na luta!`);
                    setupBattleUI();
                    
                    // Ao trocar, o inimigo ataca imediatamente (opcional, mas comum em RPGs)
                    addLog("O inimigo aproveita a troca para atacar!");
                    toggleButtons(true);
                    setTimeout(enemyTurn, 1000);
                }, "Escolha quem vai entrar:", true);
            };
            actions.appendChild(swapBtn);
        }

        document.getElementById('battle-logs').innerHTML = '';
    }

    function updateHpUI(who, creature) {
        if (!creature) return;
        const percent = Math.max(0, Math.min(100, (creature.currentHp / creature.hp) * 100));
        const bar = document.getElementById(`${who}-hp-bar`);
        const text = document.getElementById(`${who}-hp-text`);
        if (bar) bar.style.width = percent + '%';
        if (text) text.innerText = `${Math.max(0, Math.floor(creature.currentHp))}/${creature.hp}`;
    }

    function updateXpUI(creature) {
        const percent = (creature.xp / creature.maxXp) * 100;
        const bar = document.getElementById('player-xp-bar');
        const text = document.getElementById('player-xp-text');
        if (bar) bar.style.width = percent + '%';
        if (text) text.innerText = `Lvl ${creature.level} - ${creature.xp}/${creature.maxXp} XP`;
    }

    function playerAttack(atk, enemyIndex) {
        playSound('attack');
        const target = state.enemies[enemyIndex];
        const p = state.activePlayerCreature;
        
        let dmg = Math.floor(Math.random() * (atk.max - atk.min + 1)) + atk.min;
        
        // Efeitos de Itens Ofensivos (Calculados com N√≠vel do Item)
        if (p.items && p.items.length > 0) {
            p.items.forEach(item => {
                const lvl = item.level || 1;
                if (item.id === 'garra_obsidiana') dmg += (10 * lvl);
                if (item.id === 'anel_fogo') {
                    if (Math.random() > 0.5) dmg += (15 * lvl); 
                }
                if (item.id === 'amolador_presas') dmg = Math.max(dmg, 20 + (5 * (lvl-1)));
                if (item.id === 'cajado_runico' && p.isEvolved) dmg = Math.floor(dmg * (2.5 + (0.5 * (lvl-1))));
                if (item.id === 'coroa_demonio') dmg += (30 * lvl);
                if (item.id === 'espelho_mistico') {
                    if (Math.random() < (0.6 + (0.2 * (lvl-1)))) {
                        const enemyMaxAtk = Math.max(...target.attacks.map(a => a.max));
                        dmg += enemyMaxAtk;
                        addLog(`ESPELHO M√çSTICO: Refletiu +${enemyMaxAtk} de dano! (N√≠vel ${lvl})`);
                    }
                }
                // Colar de Regenera√ß√£o (Cura ao atacar)
                if (item.id === 'colar_regeneracao') {
                    const heal = Math.floor(p.hp * (0.10 * lvl));
                    p.currentHp = Math.min(p.hp, p.currentHp + heal);
                    addLog(`REGENERA√á√ÉO: ${p.name} recuperou ${heal} HP!`);
                    updateHpUI('player', p);
                }
            });
        }

        target.currentHp -= dmg;
        addLog(`${p.name} usou ${atk.name} em ${target.name}: ${dmg} dano!`);
        updateHpUI(`enemy-${enemyIndex}`, target);
        
        // Atualiza tooltip do inimigo (HP mudou)
        const enemyEl = document.getElementById(`enemy-fighter-${enemyIndex}`);
        const enemyTooltip = enemyEl.querySelector('.tooltiptext');
        if (enemyTooltip) enemyTooltip.innerHTML = getCreatureTooltip(target);

        if (target.currentHp <= 0) {
            addLog(`${target.name} foi derrotado!`);
            enemyEl.style.opacity = '0.3';
        }

        toggleButtons(true);

        const allDead = state.enemies.every(e => e.currentHp <= 0);
        if (allDead) setTimeout(winBattle, 1000);
        else setTimeout(enemyTurn, 1000);
    }

    function enemyTurn() {
        const aliveEnemies = state.enemies.filter(e => e.currentHp > 0);
        if (aliveEnemies.length === 0) { winBattle(); return; }
        
        let currentAttackerIndex = 0;
        
        function nextEnemyAttack() {
            if (currentAttackerIndex >= aliveEnemies.length) {
                if (state.activePlayerCreature.currentHp > 0) toggleButtons(false);
                return;
            }
            
            const enemy = aliveEnemies[currentAttackerIndex];
            const p = state.activePlayerCreature;
            playSound('hit');
            const atk = enemy.attacks[Math.floor(Math.random() * enemy.attacks.length)];
            let dmg = Math.floor(Math.random() * (atk.max - atk.min + 1)) + atk.min;
            
            // Efeitos de Itens Defensivos (Calculados com N√≠vel do Item)
            let dodged = false;
            if (p.items && p.items.length > 0) {
                p.items.forEach(item => {
                    const lvl = item.level || 1;
                    if (item.id === 'manto_esquiva' && Math.random() < (0.25 + (0.01 * (lvl-1)))) {
                        dodged = true;
                    }
                    if (item.id === 'escudo_espinhos' && !dodged) {
                        const reflect = Math.floor(dmg * (0.8 + (0.05 * (lvl-1))));
                        enemy.currentHp -= reflect;
                        addLog(`ESPINHOS Lvl ${lvl}: ${enemy.name} recebeu ${reflect} de volta!`);
                        updateHpUI(`enemy-${state.enemies.indexOf(enemy)}`, enemy);
                    }
                    if (item.id === 'casco_adamante' && p.currentHp === p.hp) {
                        // O HP extra j√° est√° somado no HP total
                    }
                });
            }

            if (dodged) {
                addLog(`${p.name} ESQUIVOU do ataque!`);
            }

            if (!dodged) {
                p.currentHp -= dmg;
                addLog(`${enemy.name} usou ${atk.name}: ${dmg} dano!`);
                
                // F√™nix de Bolso (Revive)
                if (p.currentHp <= 0 && p.items && p.items.length > 0) {
                    const fenixIdx = p.items.findIndex(i => i.id === 'fenix_bolso');
                    if (fenixIdx !== -1) {
                        p.currentHp = Math.floor(p.hp * 0.3);
                        p.items.splice(fenixIdx, 1); // Item quebra
                        addLog(`üî• F√äNIX DE BOLSO: ${p.name} RENASCEU DAS CINZAS!`);
                    }
                }
            }

            updateHpUI('player', p);
            
            const playerTooltip = document.querySelector('#player-fighter .tooltiptext');
            if (playerTooltip) playerTooltip.innerHTML = getCreatureTooltip(p);

            if (p.currentHp <= 0) {
                setTimeout(loseBattle, 1000);
            } else {
                currentAttackerIndex++;
                setTimeout(nextEnemyAttack, 800);
            }
        }
        
        nextEnemyAttack();
    }

    function winBattle() {
        if (state.isBossBattle) playSound('victory');
        const p = state.activePlayerCreature;
        let totalXp = 0;
        let totalDiamantes = 0;
        
        state.enemies.forEach(e => {
            totalXp += state.isBossBattle ? 500 : 40 + (e.level * 10);
            totalDiamantes += state.isBossBattle ? 200 : 20 + (e.level * 5);
        });

        // B√¥nus Grim√≥rio de Aprendiz (+30% XP)
        if (p.items && p.items.length > 0) {
            let xpBonus = 0;
            p.items.forEach(item => {
                if (item.id === 'grimorio_aprendiz') xpBonus += 1;
            });
            if (xpBonus > 0) {
                totalXp = Math.floor(totalXp * (1 + xpBonus));
                addLog(`GRIM√ìRIO: +${Math.round(xpBonus * 100)}% de XP b√¥nus!`);
            }
        }

        state.diamantes += totalDiamantes;
        addLog(`Vit√≥ria! +${totalXp} XP | +${totalDiamantes} üíé`);
        gainXp(p, totalXp);

        // Chance de Drop de Item (10% normal, 100% boss)
        const dropChance = state.isBossBattle ? 1.0 : 0.1;
        if (Math.random() < dropChance) {
            const possibleItems = Object.values(ITEMS).filter(i => !i.minLevel || state.level >= i.minLevel);
            const droppedItem = JSON.parse(JSON.stringify(possibleItems[Math.floor(Math.random() * possibleItems.length)]));
            droppedItem.level = 1; // Inicializa n√≠vel do item

            setTimeout(() => {
                showModal("DROP!", `
                    <div style="text-align:center;">
                        <img src="imagens/${droppedItem.image}" style="width:64px; height:64px; object-fit:contain; margin-bottom:10px;"><br>
                        <strong>${droppedItem.name}</strong><br>
                        <small>${droppedItem.desc}</small>
                    </div>`, [
                    { text: "Equipar", action: () => {
                        showCreatureSelection((target) => {
                            if (!target.items) target.items = [];
                            
                            if (target.items.length >= 3) {
                                // Sistema de Substitui√ß√£o/Fus√£o
                                showModal("Espa√ßos Cheios", `Escolha um item para substituir ou fundir (se for igual):`, [
                                    ...target.items.map((it, idx) => ({
                                        text: it.id === droppedItem.id ? `Fundir (+Power)` : `Subst. ${it.name}`,
                                        action: () => {
                                            if (it.id === droppedItem.id) {
                                                fuseItems(it, droppedItem);
                                                addLog(`${it.name} subiu de n√≠vel!`);
                                            } else {
                                                target.items[idx] = droppedItem;
                                                addLog(`${target.name} equipou ${droppedItem.name}!`);
                                            }
                                            finishBattleFlow();
                                        }
                                    })),
                                    { text: "Voltar", action: () => winBattle() }
                                ]);
                                return;
                            }
                            
                            target.items.push(droppedItem);
                            addLog(`${target.name} equipou ${droppedItem.name}!`);
                            finishBattleFlow();
                        }, "Quem deve equipar?");
                    }},
                    { text: "Ignorar", action: finishBattleFlow }
                ]);
            }, 1000);
            return;
        }

        finishBattleFlow();
    }

    function finishBattleFlow() {
        if (state.isBossBattle) { 
            setTimeout(showBossVictory, 1000); 
        } else {
            const lastEnemy = state.enemies[state.enemies.length - 1];
            showModal("Vit√≥ria!", `
                <div style="text-align:center;">
                    ${getCreatureImageOnly(lastEnemy, "80px")}<br>
                    Voc√™ venceu o combate contra <strong>${lastEnemy.name}</strong>!
                </div>`, [
                { text: "Capturar", action: () => captureCreature(lastEnemy) },
                { text: "Trocar", action: () => swapCreature(lastEnemy) },
                { text: "Deixar ir", action: endEvent }
            ]);
        }
    }

    function fuseItems(targetItem, sourceItem) {
        targetItem.level = (targetItem.level || 1) + 1;
        // O poder dos itens √© calculado dinamicamente no combate agora
    }

    function gainXp(creature, amount) {
        creature.xp += amount;
        while (creature.xp >= creature.maxXp) {
            creature.xp -= creature.maxXp;
            levelUp(creature);
        }
        updateUI();
    }

    function levelUp(c) {
        c.level++;
        c.maxXp = Math.floor(c.maxXp * 1.2);
        
        // Casco de Adamante (+100 HP Max) - j√° deve estar somado se o item for equipado
        // Mas garantimos que o HP aumente ao subir de n√≠vel
        c.hp += 20;
        c.currentHp = c.hp;
        c.attacks.forEach(a => { a.min += 2; a.max += 4; });
        addLog(`LEVEL UP! ${c.name} atingiu n√≠vel ${c.level}!`);
        
        // Pedra da Evolu√ß√£o Precoce (Evolui 1 n√≠vel antes por item)
        let reduction = 0;
        if (c.items) {
            c.items.forEach(item => {
                if (item.id === 'pedra_evolucao') reduction += 2;
            });
        }
        const evoLevel = c.evo ? Math.max(1, c.evo.level - reduction) : 999;
        
        if (!c.isEvolved && c.evo && c.level >= evoLevel) {
            evolve(c);
        }
    }

    function evolve(c) {
        playSound('evolution');
        const oldName = c.name;
        c.name = c.evo.name;
        c.emoji = c.evo.emoji;
        if (c.evo.image) c.image = c.evo.image;
        c.hp += c.evo.hpBoost;
        c.currentHp = c.hp;
        c.attacks.forEach(a => { a.min += c.evo.dmgBoost; a.max += c.evo.dmgBoost; });
        c.isEvolved = true;
        
        showModal("EVOLU√á√ÉO!", `
            <div style="text-align:center;">
                ${getCreatureImageOnly(c, "100px")}<br>
                <strong>${oldName}</strong> evoluiu para <strong>${c.name}</strong>!
            </div>`, [{ text: "Incr√≠vel!", action: hideModal }]);
        addLog(`EVOLU√á√ÉO! ${oldName} evoluiu para ${c.name}!`);
    }

    function loseBattle() {
        playSound('defeat');
        const p = state.activePlayerCreature;
        addLog(`${p.name} caiu!`);
        if (state.isBossBattle) {
            const alive = state.team.filter(c => c.currentHp > 0);
            if (alive.length > 0) {
                addLog("Escolha outro!");
                showCreatureSelection((s) => { state.activePlayerCreature = s; setupBattleUI(); toggleButtons(false); });
            } else gameOverBoss();
            return;
        }
        state.team.splice(state.team.indexOf(p), 1);
        updateUI();
        showModal("Derrota", `
            <div style="text-align:center;">
                ${getCreatureImageOnly(p, "80px")}<br>
                Voc√™ perdeu <strong>${p.name}</strong>...
            </div>`, [{ text: "Continuar", action: () => { stopSound(); endEvent(); } }]);
    }

    // --- Events ---

    function startEncounter(enemy) {
        showModal("Encontro", `
            <div style="text-align:center;">
                ${getCreatureImageOnly(enemy, "80px")}<br>
                Um <strong>${enemy.name}</strong> n√≠vel ${enemy.level} apareceu!
            </div>`, [
            { text: "Capturar", action: () => tryCapture(enemy) },
            { text: "Lutar", action: () => startBattle(enemy) },
            { text: "Fugir", action: endEvent }
        ]);
    }

    function tryCapture(enemy) {
        let chance = 0.5;
        // Incenso Atrativo (+30% chance de captura por item)
        let bonus = 0;
        state.team.forEach(c => {
            if (c.items) {
                c.items.forEach(item => {
                    if (item.id === 'incenso_atrativo') bonus += 0.3;
                });
            }
        });
        
        if (bonus > 0) {
            chance = Math.min(0.95, chance + bonus);
            addLog(`INCENSO ATRATIVO: +${Math.round(bonus * 100)}% de chance de captura!`);
        }

        if (Math.random() < chance) {
            showModal("Sucesso!", `
                <div style="text-align:center;">
                    ${getCreatureImageOnly(enemy, "80px")}<br>
                    Capturou <strong>${enemy.name}</strong>!
                </div>`, [{ text: "Ok", action: () => captureCreature(enemy) }]);
        } else {
            showModal("Falhou!", `
                <div style="text-align:center;">
                    ${getCreatureImageOnly(enemy, "80px")}<br>
                    Ele atacou!
                </div>`, [{ text: "Lutar", action: () => startBattle(enemy) }]);
        }
    }

    function showBossVictory() {
        const capturedBoss = JSON.parse(JSON.stringify(BOSS));
        capturedBoss.hp = Math.floor(capturedBoss.hp * 0.3);
        capturedBoss.attacks.forEach(a => {
            a.min = Math.floor(a.min * 0.3);
            a.max = Math.floor(a.max * 0.3);
        });
        capturedBoss.name = "Mini " + capturedBoss.name;

        showModal("VIT√ìRIA!", `
            <div style="text-align:center;">
                ${getCreatureImageOnly(BOSS, "100px")}<br>
                Voc√™ derrotou o Chefe! Deseja captur√°-lo com 30% do poder?
            </div>`, [
            { text: "Sim, Capturar!", action: () => { 
                captureCreature(capturedBoss, true); // true indica que √© captura de boss
            } },
            { text: "N√£o, Apenas Continuar", action: continueAfterBoss }
        ]);
    }

    function captureCreature(c, isBoss = false) {
        c.currentHp = c.hp; // Vida cheia ao capturar
        
        const nextAction = isBoss ? continueAfterBoss : endEvent;

        // Verifica se j√° tem uma criatura igual para fus√£o
        const duplicate = state.team.find(t => t.id === c.id);
        if (duplicate) {
            showModal("Criatura Repetida!", `
                <div style="text-align:center;">
                    ${getCreatureImageOnly(c, "80px")}<br>
                    Voc√™ j√° tem um <strong>${c.name}</strong>. O que deseja fazer?
                </div>`, [
                { text: "Fundir (Power Up!)", action: () => { fuseCreatures(duplicate, c); nextAction(); } },
                { text: "Manter Ambos", action: () => addToTeam(c, isBoss) }
            ]);
        } else {
            addToTeam(c, isBoss);
        }
    }

    function addToTeam(c, isBoss = false) {
        const nextAction = isBoss ? continueAfterBoss : endEvent;
        if (state.team.length < state.maxTeamSize) { 
            state.team.push(c); 
            healTeamOnCapture();
            nextAction(); 
        }
        else {
            showModal("Time Cheio", "Trocar uma?", [
                { text: "Trocar", action: () => swapCreature(c, isBoss) }, 
                { text: "Deixar ir", action: nextAction }
            ]);
        }
    }

    function swapCreature(newC, isBoss = false) {
        const nextAction = isBoss ? continueAfterBoss : endEvent;
        showCreatureSelection((s) => { 
            state.team[state.team.indexOf(s)] = newC; 
            nextAction(); 
        }, `
            <div style="text-align:center;">
                ${getCreatureImageOnly(newC, "64px")}<br>
                Remover qual para dar lugar a <strong>${newC.name}</strong>?
            </div>`);
    }

    function fuseCreatures(existing, newC) {
        existing.level += 1;
        existing.hp += 30;
        existing.currentHp = existing.hp;
        existing.attacks.forEach(a => { a.min += 5; a.max += 8; });
        
        if (newC.level > 1) {
            existing.xp += 50;
            if (existing.xp >= existing.maxXp) gainXp(existing, 0);
        }
        
        addLog(`FUS√ÉO! ${existing.name} ficou mais forte!`);
        healTeamOnCapture();
    }

    function healTeamOnCapture() {
        state.team.forEach(creature => {
            const healAmount = creature.hp * 0.25;
            creature.currentHp = Math.min(creature.hp, creature.currentHp + healAmount);
        });
        addLog("Sua equipe recuperou um pouco de vida!");
    }

    function handleTreasure() {
        showModal("Ba√∫ de Tesouro", "Voc√™ encontrou um ba√∫ misteriosoüçÄüíÄ! Deseja abri-lo? (Pode conter recompensas ou armadilhas!)", [
            { text: "Abrir Ba√∫", action: openTreasure },
            { text: "Deixar para l√°", action: endEvent }
        ]);
    }

    function openTreasure() {
        playSound('treasure');
        const r = Math.random();
        
        // Bolsa de Moedas (+50 diamantes)
        let bonusDiamantes = 0;
        state.team.forEach(c => {
            if (c.items && c.items.length > 0) {
                c.items.forEach(item => {
                    if (item.id === 'bolsa_moedas') bonusDiamantes += 100;
                });
            }
        });
        if (bonusDiamantes > 0) {
            addLog(`BOLSA DE MOEDAS: +${bonusDiamantes} diamantes b√¥nus!`);
        }

        if (r < 0.3) {
            const c = getRandomEnemy();
            showModal("Ovo!", `
                <div style="text-align:center;">
                    ${getCreatureImageOnly(c, "80px")}<br>
                    Ganhou um <strong>${c.name}</strong>!
                </div>`, [{ text: "Chocar", action: () => captureCreature(c) }]);
        } else if (r < 0.6) {
            const g = 50 + (state.level * 10) + bonusDiamantes;
            state.diamantes += g;
            showModal("Diamante!", `Encontrou um ba√∫ com ${g} üíé!`, [{ text: "Pegar", action: endEvent }]);
        } else if (r < 0.8) {
            state.team.forEach(c => { 
                c.hp += 10; c.currentHp = c.hp; 
                c.attacks.forEach(a => { a.min += 2; a.max += 2; });
            });
            showModal("B√™n√ß√£o", "Time fortalecido!", [{ text: "Legal!", action: endEvent }]);
        } else {
            // Chance de encontrar item aleat√≥rio no ba√∫ (20% do r >= 0.8)
            if (Math.random() < 0.3) {
                const possibleItems = Object.values(ITEMS).filter(i => !i.minLevel || state.level >= i.minLevel);
                const foundItem = JSON.parse(JSON.stringify(possibleItems[Math.floor(Math.random() * possibleItems.length)]));
                foundItem.level = 1;
                
                showModal("Item Encontrado!", `
                    <div style="text-align:center;">
                        <img src="imagens/${foundItem.image}" style="width:64px; height:64px; object-fit:contain; margin-bottom:10px;"><br>
                        <strong>${foundItem.name}</strong><br>
                        <small>${foundItem.desc}</small>
                    </div>`, [
                    { text: "Equipar", action: () => {
                        showCreatureSelection((target) => {
                            if (!target.items) target.items = [];
                            
                            if (target.items.length >= 3) {
                                // Sistema de Substitui√ß√£o/Fus√£o
                                showModal("Espa√ßos Cheios", `Escolha um item para substituir ou fundir (se for igual):`, [
                                    ...target.items.map((it, idx) => ({
                                        text: it.id === foundItem.id ? `Fundir (+Power)` : `Subst. ${it.name}`,
                                        action: () => {
                                            if (it.id === foundItem.id) {
                                                fuseItems(it, foundItem);
                                                addLog(`${it.name} subiu de n√≠vel!`);
                                            } else {
                                                target.items[idx] = foundItem;
                                                addLog(`${target.name} equipou ${foundItem.name}!`);
                                            }
                                            endEvent();
                                        }
                                    })),
                                    { text: "Voltar", action: () => openTreasure() }
                                ]);
                                return;
                            }
                            
                            target.items.push(foundItem);
                            addLog(`${target.name} equipou ${foundItem.name}!`);
                            endEvent();
                        }, "Quem deve equipar?");
                    }},
                    { text: "Ignorar", action: endEvent }
                ]);
                return;
            }

            if (state.team.length > 1) {
                showModal("Armadilha!", "O ba√∫ era uma armadilha! Uma de suas criaturas fugiu assustada. Escolha qual perder:", []);
                const f = document.getElementById('modal-footer');
                f.innerHTML = '';
                state.team.forEach(c => {
                    const d = document.createElement('div');
                    d.className = 'creature-card tooltip';
                    d.innerHTML = `
                        ${getCreatureDisplay(c, 'creature-img')}<br>${c.name}
                        <span class="tooltiptext">${getCreatureTooltip(c)}</span>
                    `;
                    d.onclick = () => {
                        state.team.splice(state.team.indexOf(c), 1);
                        addLog(`${c.name} fugiu da armadilha!`);
                        endEvent();
                    };
                    f.appendChild(d);
                });
            } else showModal("Vazio", "O ba√∫ estava vazio...", [{ text: "Ok", action: endEvent }]);
        }
    }

    function endEvent() {
        hideModal();
        
        // Gerencia o descanso das criaturas
        state.team.forEach(c => {
            if (c.restCount > 0) c.restCount--;
        });

        saveGame();
        document.getElementById('battle-screen').style.display = 'none';
        document.getElementById('exploration-grid').classList.remove('hidden');
        updateUI();
        if (state.cardsRevealed >= 6) { 
            if (state.level < 50) {
                setTimeout(showShop, 500);
            } else {
                // Se j√° estiver no 50 (fim do jogo), n√£o faz nada especial aqui
            }
        }
    }

    function showShop() {
        const shopTitle = `Loja do N√≠vel ${state.level}`;
        const shopBody = state.selectingLock ? 
            "<strong style='color: gold;'>MODO DE TRAVA: Clique no item que deseja fixar!</strong>" : 
            "Bem-vindo! Use seus diamantes para fortalecer sua equipe.";
        const rerollCost = 20;
        
        showModal(shopTitle, shopBody, [
            { text: `Novas Escolhas (${rerollCost} üíé)`, action: () => {
                if (state.diamantes >= rerollCost) {
                    state.diamantes -= rerollCost;
                    state.currentShopItems = null; // Limpa para gerar novos
                    updateUI();
                    showShop();
                    addLog("Loja renovada!");
                } else {
                    alert("Diamantes insuficientes!");
                }
            }},
            { text: state.lockedShopItem ? "Destravar Item" : "Travar Item", action: () => {
                if (state.lockedShopItem) {
                    state.lockedShopItem = null;
                    addLog("Item destravado!");
                    showShop();
                } else {
                    state.selectingLock = !state.selectingLock;
                    showShop();
                }
            }},
            { text: "Pr√≥ximo N√≠vel", action: () => { 
                hideModal(); 
                state.level++; 
                state.currentShopItems = null; // Limpa para o pr√≥ximo n√≠vel
                generateLevel(); 
            } }
        ], true);

        const f = document.getElementById('modal-footer');
        f.innerHTML = '';

        // --- Itens de Consumo ---
        const healCost = 40 + (state.level * 10);
        createShopItem("Po√ß√£o Grupal", "Cura 50% de HP de todos.", healCost, null, "üß™", () => {
            if (state.selectingLock) return false; // N√£o permite travar consum√≠veis
            state.team.forEach(c => c.currentHp = Math.min(c.hp, c.currentHp + (c.hp * 0.5)));
            addLog("Equipe curada pela po√ß√£o!");
            updateUI();
        });

        // --- Equipamentos Aleat√≥rios (3 itens) ---
        if (!state.currentShopItems) {
            const allItems = Object.values(ITEMS).filter(i => !i.minLevel || state.level >= i.minLevel);
            let selected = [];
            
            // Se houver um item travado, ele ocupa a primeira vaga
            if (state.lockedShopItem) {
                // Tenta encontrar o item atualizado no pool (caso tenha subido de n√≠vel o pool)
                const lockedInPool = allItems.find(i => i.id === state.lockedShopItem.id);
                selected.push(lockedInPool || state.lockedShopItem);
            }

            const poolForShuffle = allItems.filter(i => !state.lockedShopItem || i.id !== state.lockedShopItem.id)
                                .sort(() => 0.5 - Math.random());
            
            while (selected.length < 3 && poolForShuffle.length > 0) {
                selected.push(poolForShuffle.pop());
            }
            state.currentShopItems = selected;
        }

        state.currentShopItems.forEach((item, idx) => {
            const isLocked = state.lockedShopItem && state.lockedShopItem.id === item.id;
            const nameDisplay = isLocked ? `üîí ${item.name}` : item.name;

            createShopItem(nameDisplay, item.desc, item.cost, item.image, null, () => {
                // Se estiver no modo de sele√ß√£o de trava
                if (state.selectingLock) {
                    state.lockedShopItem = item;
                    state.selectingLock = false;
                    addLog(`Item ${item.name} travado para a pr√≥xima visita!`);
                    showShop();
                    return false;
                }

                showCreatureSelection((target) => {
                    if (!target.items) target.items = [];
                    
                    const boughtItem = JSON.parse(JSON.stringify(item));
                    boughtItem.level = 1;

                    if (target.items.length >= 3) {
                        // Sistema de Substitui√ß√£o/Fus√£o
                        showModal("Espa√ßos Cheios", `Escolha um item para substituir ou fundir (se for igual):`, [
                            ...target.items.map((it, itIdx) => ({
                                text: it.id === boughtItem.id ? `Fundir (+Power)` : `Subst. ${it.name}`,
                                action: () => {
                                    if (it.id === boughtItem.id) {
                                        fuseItems(it, boughtItem);
                                        addLog(`${it.name} subiu de n√≠vel!`);
                                    } else {
                                        target.items[itIdx] = boughtItem;
                                        addLog(`${target.name} equipou ${boughtItem.name}!`);
                                    }
                                    state.diamantes -= item.cost;
                                    if (isLocked) state.lockedShopItem = null; // Destrava se comprar
                                    
                                    // Remove o item da loja ap√≥s comprar
                                    state.currentShopItems.splice(idx, 1);
                                    
                                    updateUI();
                                    showShop();
                                }
                            })),
                            { text: "Voltar", action: () => showShop() }
                        ]);
                        return;
                    }
                    
                    // Efeito imediato: Casco de Adamante
                    if (boughtItem.id === 'casco_adamante') {
                        target.hp += 100;
                        target.currentHp += 100;
                    }
                    // Efeito imediato: Coroa do Dem√¥nio
                    if (boughtItem.id === 'coroa_demonio') {
                        target.hp = Math.floor(target.hp / 2);
                        target.currentHp = Math.min(target.currentHp, target.hp);
                    }

                    target.items.push(boughtItem);
                    state.diamantes -= item.cost;
                    if (isLocked) state.lockedShopItem = null; // Destrava se comprar
                    
                    // Remove o item da loja ap√≥s comprar
                    state.currentShopItems.splice(idx, 1);

                    addLog(`${target.name} equipou ${item.name}!`);
                    updateUI();
                    showShop(); // Reabre a loja ap√≥s equipar
                }, "Quem deve equipar este item?");
                return false; // N√£o subtrai diamantes aqui, j√° subtra√≠mos no callback acima
            });
        });

        // --- Treinos ---
        const atkCost = 60 + (state.level * 15);
        createShopItem("Treino For√ßa", "+5 Dano (Min/Max) p/ um", atkCost, null, "‚öîÔ∏è", () => {
            if (state.selectingLock) return false;
            showCreatureSelection((c) => {
                c.attacks.forEach(a => { a.min += 5; a.max += 5; });
                state.diamantes -= atkCost;
                addLog(`${c.name} aumentou seu dano!`);
                updateUI();
                showShop();
            }, "Escolha quem treinar:");
            return false;
        });

        const hpCost = 50 + (state.level * 10);
        createShopItem("Vitaminas", "+40 HP M√°ximo p/ um", hpCost, null, "üíä", () => {
            if (state.selectingLock) return false;
            showCreatureSelection((c) => {
                c.hp += 40;
                c.currentHp += 40;
                state.diamantes -= hpCost;
                addLog(`${c.name} aumentou sua vida!`);
                updateUI();
                showShop();
            }, "Escolha quem fortalecer:");
            return false;
        });
    }

    function createShopItem(name, desc, cost, image, emoji, action) {
        const f = document.getElementById('modal-footer');
        const d = document.createElement('div');
        d.className = 'creature-card';
        if (state.diamantes < cost) d.style.opacity = '0.5';
        
        let displayHtml = image ? 
            `<img src="imagens/${image}" style="width:40px; height:40px; object-fit:contain; margin-bottom:5px;">` : 
            `<span style="font-size: 2rem;">${emoji}</span>`;

        d.innerHTML = `
            ${displayHtml}<br>
            <strong>${name}</strong><br>
            <small style="font-size:0.7rem;">${desc}</small><br>
            <strong>${cost} üíé</strong>
        `;
        
        d.onclick = () => {
            if (state.diamantes >= cost || state.selectingLock) {
                const result = action();
                if (result !== false) {
                    state.diamantes -= cost;
                    updateUI();
                    showShop();
                }
            } else {
                alert("Diamantes insuficiente!");
            }
        };
        f.appendChild(d);
    }

    function startBossBattle() {
        document.getElementById('exploration-grid').classList.add('hidden');
        const multiplier = 1 + (Math.floor(state.level / 10) - 1) * 0.5;
        const currentBoss = JSON.parse(JSON.stringify(BOSS));
        currentBoss.hp = Math.floor(currentBoss.hp * multiplier);
        currentBoss.attacks.forEach(a => {
            a.min = Math.floor(a.min * multiplier);
            a.max = Math.floor(a.max * multiplier);
        });
        
        showModal(`CHEFE DO N√çVEL ${state.level}`, `
            <div style="text-align:center;">
                ${getCreatureImageOnly(currentBoss, "120px")}<br>
                <strong>${currentBoss.name}</strong>
            </div>`, [{ text: "LUTAR", action: () => startBattle(initCreature(currentBoss), true) }]);
    }

    function gameOver() { showModal("FIM", "Perdeu tudo.", [{ text: "Reiniciar", action: () => { location.reload(); } }]); }

    function gameOverBoss() {
        showModal("DERROTA", `
            <div style="text-align:center;">
                ${getCreatureImageOnly(BOSS, "100px")}<br>
                O Rei venceu. Escolha um para renascer:
            </div>`, []);
        const f = document.getElementById('modal-footer');
        f.innerHTML = '';
        state.team.forEach(c => {
            const d = document.createElement('div'); d.className = 'creature-card';
            d.innerHTML = `${getCreatureDisplay(c, 'creature-img')}<br>${c.name}`;
            d.onclick = () => {
                stopSound();
                const t = [initCreature(CREATURE_POOL[0]), initCreature(CREATURE_POOL[1]), c];
                c.currentHp = c.hp;
                state.team = t;
                state.level = Math.max(1, state.level - 9);
                hideModal(); initGame(true);
            };
            f.appendChild(d);
        });
    }

    function continueAfterBoss() {
        if (state.level >= 50) {
            showModal("GRANDE VIT√ìRIA!", "Voc√™ completou todos os 50 n√≠veis e dominou o mundo das criaturas!", [
                { text: "Jogar Novamente", action: () => location.reload() }
            ]);
            return;
        }

        showModal("Progresso", `N√≠vel ${state.level} conclu√≠do! Prepare-se para o pr√≥ximo desafio.`, [
            { text: "Continuar", action: () => {
                state.level++;
                generateLevel();
                hideModal();
            }}
        ]);
    }

    // --- UI Utils ---
    function getCreatureDisplay(c, className = "") {
        let itemsHtml = "";
        if (c.items && c.items.length > 0) {
            itemsHtml = `<div style="position: absolute; bottom: 0; right: 0; display: flex; flex-direction: row-reverse; gap: 2px; z-index: 5;">`;
            c.items.forEach(item => {
                itemsHtml += `<div title="${item.name}" style="background: rgba(0,0,0,0.6); border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border: 1px solid gold; overflow: hidden;">
                    <img src="imagens/${item.image}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='${item.icon}'">
                </div>`;
            });
            itemsHtml += `</div>`;
        }

        if (c.image) {
            return `<div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                        <img src="imagens/${c.image}" alt="${c.name}" class="${className}" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <span style="display:none; font-size: 4rem;">${c.emoji}</span>
                        ${itemsHtml}
                    </div>`;
        }
        return `<div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"><span style="font-size: 4rem;">${c.emoji}</span>${itemsHtml}</div>`;
    }

    function getCreatureImageOnly(c, size = "64px") {
        if (c.image) {
            return `<img src="imagens/${c.image}" style="width:${size}; height:${size}; object-fit:contain; display:block; margin: 0 auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><span style="display:none; font-size: 3rem;">${c.emoji}</span>`;
        }
        return `<span style="font-size: 3rem; display:block; text-align:center;">${c.emoji}</span>`;
    }

    function getCreatureTooltip(c) {
        let attacksInfo = c.attacks.map(a => `‚Ä¢ ${a.name}: ${a.min}-${a.max}`).join('<br>');
        let itemsInfo = (c.items && c.items.length > 0) ? `<br>--- Equipamentos ---<br>${c.items.map(i => {
            const lvl = i.level || 1;
            return `<img src="imagens/${i.image}" style="width:20px; vertical-align:middle;"> <strong>${i.name} (Lvl ${lvl})</strong><br><small style="color:#ccc;">${i.desc}</small>`;
        }).join('<br>')}` : '';
        return `
            <strong>${c.name} (Lvl ${c.level})</strong><br>
            HP: ${Math.floor(c.currentHp)}/${c.hp}<br>
            ${c.xp !== undefined ? `XP: ${c.xp}/${c.maxXp}<br>` : ''}--- Ataques ---<br>
            ${attacksInfo}${itemsInfo}
        `;
    }

    function showModal(t, b, btns, showDiamonds = false) {
        playSound('click');
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('modal-title').innerText = t;
        document.getElementById('modal-body').innerHTML = b;
        document.getElementById('modal-actions').innerHTML = '';
        const f = document.getElementById('modal-footer'); f.innerHTML = '';
        
        const diamondHud = document.getElementById('modal-diamonds-hud');
        if (showDiamonds) {
            diamondHud.classList.remove('hidden');
            document.getElementById('modal-diamonds-val').innerText = state.diamantes;
        } else {
            diamondHud.classList.add('hidden');
        }

        btns.forEach(btn => {
            const el = document.createElement('button'); el.innerText = btn.text; el.onclick = btn.action;
            document.getElementById('modal-actions').appendChild(el);
        });
    }

    function hideModal() { 
        playSound('click');
        document.getElementById('overlay').style.display = 'none'; 
    }

    function showCreatureSelection(cb, t = "Escolha:", filterResting = false) {
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('modal-title').innerText = t;
        document.getElementById('modal-body').innerText = "";
        document.getElementById('modal-actions').innerHTML = '';
        const f = document.getElementById('modal-footer'); f.innerHTML = '';
        
        // Esconde HUD de diamantes se estiver vindo da loja para sele√ß√£o
        document.getElementById('modal-diamonds-hud').classList.add('hidden');

        state.team.forEach(c => {
            const isResting = filterResting && c.restCount > 0;
            const d = document.createElement('div'); 
            d.className = 'creature-card' + (c.currentHp <= 0 ? ' dead' : '') + (isResting ? ' resting' : '');
            
            let statusText = "";
            if (c.currentHp <= 0) statusText = "<br><span style='color:red;'>DERROTADO</span>";
            else if (isResting) statusText = "<br><span style='color:orange;'>CANSADO</span>";

            d.innerHTML = `
                ${getCreatureDisplay(c, 'creature-img')}<br>${c.name}<br>Lvl ${c.level}${statusText}
            `;
            
            d.ondblclick = (e) => {
                e.stopPropagation();
                showModal("Status: " + c.name, getCreatureTooltip(c), [
                    { text: "Voltar", action: () => showCreatureSelection(cb, t) }
                ]);
            };

            if (c.currentHp > 0 && !isResting) d.onclick = () => { hideModal(); cb(c); };
            f.appendChild(d);
        });
    }

    function addLog(m) {
        const l = document.getElementById('battle-logs');
        const d = document.createElement('div'); d.innerText = m;
        l.appendChild(d); l.scrollTop = l.scrollHeight;
    }

    function toggleButtons(d) { document.querySelectorAll('#battle-actions button').forEach(b => b.disabled = d); }

    // Ao carregar a p√°gina
    window.onload = () => {
        const saved = localStorage.getItem('aventura_save');
        if (saved) {
            document.getElementById('continue-btn').disabled = false;
        }
    };
</script>
</body>
</html>
